# U-Mamba: Enhancing Long-range Dependency for Biomedical Image Segmentation

U-Mamba: 提升生物医学图像分割的长程依赖性

## Abstract

卷积神经网络 (CNNs) 和 Transformer 已成为生物医学图像分割领域最受欢迎的架构，但由于固有的局部性或计算复杂性，它们在处理长程依赖性方面存在一定的限制。为了应对这一挑战，我们引入了 U-Mamba，这是一个用于生物医学图像分割的通用网络。受到状态空间序列模型 (SSMs) 的启发，这是一类以其强大的处理长序列能力而闻名的深度序列模型，我们设计了一个混合的 CNN-SSM 块，它整合了卷积层的局部特征提取能力和 SSMs 对长程依赖性的捕捉能力。此外，U-Mamba 具有自配置机制，使其能够在无需手动干预的情况下自动适应各种数据集。我们在四个不同任务上进行了大量实验，包括 CT 和 MR 图像中的 3D 腹部器官分割、内窥镜图像中的器械分割以及显微镜图像中的细胞分割。结果显示，U-Mamba 在所有任务上均优于基于 CNN 和 Transformer 的最新分割网络。这为在生物医学图像分析中高效处理长程依赖性建立了新的途径。代码、模型和数据可在 https://wanglab.ai/u-mamba.html 上公开获取。

## Introduction

分割在生物医学图像分析中充当基础过程，将图像划分为医生和生物学家感兴趣的有意义的解剖结构或区域。这项任务在各种生物医学应用中至关重要，如疾病诊断、癌症微环境定量分析、治疗策略规划以及疾病进展跟踪。手动分割是完成这项任务的一种直接方式，但非常耗时且需要广泛的领域知识，在实践中不切实际。因此，对自动分割方法的需求非常迫切。在过去的十年中，分割方法学经历了从基于数学模型或手工制作特征的方法到基于深度学习的范式的转变，这显著提高了广泛生物医学任务的分割准确性和效率，如在三维计算机断层扫描 (CT) 中的肿瘤分割和器官分割，以及显微镜图像中的细胞分割。

两种流行的网络架构，卷积神经网络 (CNNs) 和 Transformer，在医学图像分割中变得备受关注。CNNs，如 U-Net 和 DeepLab，在提取分层图像特征方面效率高，比朴素的全连接网络更具参数效率。它们的共享权重架构使它们擅长捕捉平移不变性并识别局部特征。Transformers 最初是为自然语言处理而设计的，但已成功地被调整用于图像处理，例如 Vision Transformer (ViT) 用于图像识别和 SwinTransformer 用于各种视觉任务的通用骨干。与 CNNs 不同，Transformers 并不本质上处理空间图像层次结构，而是将图像视为一系列补丁。这种方法更有能力捕捉全局信息。由于这种互补的特性，许多研究探索了通过混合网络架构将 Transformers 引入 CNNs，例如 TransUNet、UNETR、nnFormer 和 SwinUNETR。

虽然 Transformers 提高了处理长程依赖性的能力，但它们通常计算成本很高。这是因为自注意机制随输入大小呈二次方增长，使其资源密集型，特别是对于通常具有高分辨率的生物医学图像而言。因此，如何在 CNNs 中有效增强长程依赖性仍然是一个悬而未决的问题。最近，状态空间序列模型 (SSMs)，特别是结构化的状态空间序列模型 (S4)，已经成为构建深度网络的高效且有效的基本组件 (或层) ，在连续长序列数据分析方面取得了尖端性能。Mamba 通过引入一种选择机制进一步改进了S4，使模型能够以与输入相关的方式选择相关信息。通过与硬件感知的实现相结合，Mamba 在语言和基因组等密集模态上超越了 Transformers。另一方面，状态空间模型在视觉任务上也展现出有希望的结果，例如图像和视频分类。由于图像补丁和图像特征可以被视为序列，这些吸引人的 SSMs 特性激发了我们探索在 CNNs 中使用 Mamba 块增强长程建模能力的潜力。

在本文中，我们提出了 U-Mamba，一个通用网络，用于 3D 和 2D 生物医学图像分割。基于创新的混合 CNN-SSM 架构，U-Mamba 能够捕捉图像中的局部细粒度特征和长程依赖关系。与常见的基于 Transformer 的架构不同，该网络通过在特征大小上实现线性缩放，而不是通常与 Transformer 相关的二次复杂度，从而脱颖而出。此外，U-Mamba 的自配置能力使其能够无缝适应各种数据集，提升了其在各种生物医学分割任务中的可扩展性和灵活性。对四个不同数据集的定量和定性结果表明，U-Mamba 取得了卓越的性能，远远超过了基于 Transformer 的网络。这为未来在高效有效地建模生物医学成像中的长程依赖关系方面进行网络设计的进一步发展打下了基础。

## Method

U-Mamba 采用编码器-解码器网络结构，以一种高效的方式捕捉局部特征和长程上下文。图 1 展示了 U-Mamba 块和完整网络结构的概述。接下来，我们首先介绍 Mamba 块，然后说明 U-Mamba 的细节。

![image-20240307161643566](https://cdn.jsdelivr.net/gh/ZL85/ImageBed@main//202403071617264.png)

> U-Mamba (Enc) 架构概述。a，U-Mamba 构建块包含两个连续的残差块，后跟基于 SSM 的 Mamba 块，以增强长程依赖性建模。b，U-Mamba 采用编码器-解码器框架，其中编码器中包含 U-Mamba 块，解码器中包含残差块，以及跳跃连接。注意：此图示仅作为概念表示。U-Mamba 继承了 nnU-Net 的自配置特性，网络块的数量在各个数据集上自动确定。详细的网络配置见表2。

![image-20240307164757021](https://cdn.jsdelivr.net/gh/ZL85/ImageBed@main//202403071647071.png)

### Mamba: Selective Structured State Space Sequence Models with a Scan (S6)

状态空间序列模型 (SSMs) 是一种将一维函数或序列 $u(t)$ 映射到$y(t)∈R$的系统类型，可以表示为以下线性常微分方程 (ODE)：

$x'(t)=\mathbf{A}x(t)+\mathbf{B}u(t)$

$y(t)=\mathbf{C}x(t)$

其中，状态矩阵 $A∈R^{N×N}$，而 $B,C∈R^{N}$ 是其参数，$x(t)∈R^{N}$ 表示隐式潜在状态。SSMs 具有一些理想的特性，例如每个时间步的线性计算复杂度和用于有效训练的并行化计算。然而，朴素的 SSMs 通常比等效的 CNNs 要求更多的内存，并且在训练过程中常常遇到梯度消失的问题，从而限制了它们在一般序列建模中的广泛应用。

结构化状态空间序列模型 (S4) 通过在状态矩阵 $A$ 上施加结构形式并引入一种有效算法，显著改进了朴素的 SSMs。具体而言，状态矩阵是通过高阶多项式投影算子 (HIPPO) 进行构建和初始化的，从而允许构建具有丰富能力和高效长程推理能力的深度序列模型。作为一种新型网络架构，S4 在具有挑战性的 Long Range Arena Benchmark 上明显超过了 Transformers。

最近，Mamba 通过两个关键改进在离散数据建模 (例如文本和基因组) 方面进一步推进了 SSMs。首先，Mamba 采用了与传统的时间和输入不变的 SSMs 不同的输入相关的选择机制，允许从输入中进行高效的信息筛选。这是通过基于输入数据参数化 SSM 参数来实现的。其次，开发了一种硬件感知算法，其在序列长度上呈线性缩放，通过扫描进行模型的递归计算，使得 Mamba 在现代硬件上比先前的方法更快。此外，Mamba 架构将 SSM 块与线性层合并，明显更简单，并在包括语言和基因组在内的各种长序列领域展示了最新的性能，显示出在训练和推理期间的显著计算效率。

### U-Mamba: Marry Mamba with U-Net

Mamba 在各种离散数据上展示了令人印象深刻的结果，然而其在建模图像数据，特别是在生物医学成像方面的潜力仍然未被充分挖掘。考虑到图像本质上是从连续信号中采样得到的离散数据，并在展平时可被视为长序列，我们提出利用 Mamba 的线性缩放优势来增强 CNNs 对长程依赖性的建模能力。Transformer 已成功应用于处理图像，如 ViT 和 SwinTransformer，但它们在处理大图像时往往面临高计算负担，因为自注意力具有二次复杂度。这些因素激发了我们利用 Mamba 的线性缩放特性来增强 CNNs 对长程依赖性的潜力。

U-Net 及其变种在医学图像分割中一直是广泛采用的网络架构。它们通常采用对称的编码器-解码器架构，通过卷积操作提取多尺度图像特征。然而，这种架构设计在模拟图像中的长程依赖性方面具有一定的局限性，因为卷积核本质上是局部的。每个卷积层只能捕捉有限的感知域中的特征。虽然 U-Net 中的跳跃连接有助于将低层次的细节与高层次的特征结合起来，但它们主要强调的是局部特征的整合，而不是扩展网络对长程依赖性建模的能力。

U-Mamba 旨在在医学图像分割中获取 U-Net 和 Mamba 的优势，以实现对全局上下文的理解。如图1a所示，每个构建块包含两个连续的残差块，后跟一个Mamba块。残差块包含普通卷积层，后跟实例归一化 (IN) 和 Leaky ReLU 。具有形状 $(B, C, H, W, D)$ 的图像特征然后被展平并转置为 $(B, L, C)$，其中 $L = H × W × D$。在通过层标准化 后，特征进入包含两个并行分支的 Mamba 块。在第一个分支中，特征通过线性层扩展为 $(B, 2L, C)$，然后经过 $1D$ 卷积层、SiLU 激活函数，以及 SSM 层。在第二个分支中，特征也通过线性层扩展为 $(B, 2L, C)$，然后经过SiLU 激活函数。之后，两个分支的特征通过 Hadamard 乘积进行合并。最后，特征投影回原始形状 $(B, L, C)$，然后重新整形和转置为 $(B, C, H, W, D)$。

图1b显示了完整的 U-Mamba 网络架构，其中编码器由上述块构建，以捕捉局部特征和长程依赖性。解码器由残差块和转置卷积组成，专注于详细的局部信息和分辨率恢复。此外，我们继承了 U-Net 中的跳跃连接，将来自编码器的分层特征连接到解码器。最终的解码器特征传递到一个 $1×1×1$ 卷积层，再加上一个 Softmax 层，生成最终的分割概率图。此外，我们还实现了一个 U-Mamba 变体，其中只有瓶颈部分使用 U-Mamba 块，其他部分为普通的残差块。我们使用 “U-Mamba_Bot” 和 “U-Mamba_Enc” 来区分这两个网络变体，它们分别在瓶颈和所有编码器块中使用 U-Mamba 块。

## Experiments and results

### Datasets

我们使用了四个医学图像数据集来评估U-Mamba在不同图像大小、分割目标和模态之间的性能和可扩展性。

表格1呈现了数据集的概述。所有这些数据集都是公开可用的，并且允许用于研究目的。

![image-20240307170311397](https://cdn.jsdelivr.net/gh/ZL85/ImageBed@main//202403071703470.png)

**Abdomen CT (腹部CT)：**这个数据集来自 MICCAI 2022 FLARE 挑战，重点是对 13 个腹部器官进行分割，包括肝脏、脾脏、胰腺、右肾、左肾、胃、胆囊、食管、主动脉、下腔静脉、右肾上腺、左肾上腺和十二指肠。训练集包含了来自 MSD 胰腺数据集的50个 CT 扫描，标注来自 AbdomenCT-1K。另外，来自不同医疗中心的另外 50 例病例用于评估，标注由挑战组织者提供。

**Abdomen MRI (腹部MRI)：**这个数据集来自 MICCAI 2022 AMOS 挑战，也专注于腹部器官分割。原始数据集包含 40 个 MRI 扫描用于训练，20 个用于验证。由于 20 例不足以得出统计上显著的结果，在我们的实验中，我们使用了原始的 60 个带标签的 MRI 扫描进行模型训练，并标注了另外 50 个 MRI 扫描作为测试集。为了实现对腹部器官的不同模态进行比较，我们还专注于与腹部 CT 数据集相同的 13 个器官。标注是由放射科医生在 MedSAM 和 ITK-SNAP 的协助下生成的。我们已经将这个新的带有注释的数据集发布给社区，以促进 MRI 中腹部器官分割的发展。

**Endoscopy images (内窥镜图像)：**这个数据集来自 MICCAI 2017 内窥镜挑战，重点是从内窥镜图像中分割出七种器械，包括大型针头驱动器、Prograsp forceps、单极曲剪刀、Cadiere forceps、双极 forceps、血管封闭器，以及额外的插入式超声探针。我们遵循了官方数据集分割，其中训练集分别包含 1800 和 1200 个图像帧。训练图像来自八个视频，而测试集包含来自另外两个新视频的未见图像。

**Microscopy images (显微镜图像)：**这个数据集来自 NeurIPS 2022 细胞分割挑战，侧重于在各种显微镜图像中进行细胞分割。我们分别使用了 1000 和 101 张图像进行训练和评估。与前面三个任务不同，这是一个实例分割任务，算法被期望为每个细胞实例分配一个唯一的标签。在我们的实验中，我们通过预测细胞边界和内部区域，将实例分割转化为语义分割任务，因为它们可以通过`skimage.measure.label`函数轻松转换为实例掩码。值得注意的是，我们的目的是对比网络架构的性能，而不是追求该任务的最新性能。U-Mamba 也可以作为最先进的实例分割框架中的主干网络。我们将这个扩展作为未来的工作。

### Implementation and training protocols

我们在流行的 nnU-Net 框架中实现了 U-Mamba，这个选择基于两个期望的特性。首先，nnU-Net 的模块化设计与我们引入新的网络架构的重点完美契合。这种设计使我们能够集中精力在网络的实现上，同时控制其他变量，如图像预处理和数据增强。这样的设置使得在统一条件下，通过网络架构是唯一不同的因素，可以公平比较 U-Mamba 与各种方法的性能。其次，nnU-Net 显著的自配置框架，能够自动配置多样的分割数据集的超参数，是我们选择的另一个引人注目的原因。我们还保留了这一特性，使得 U-Mamba 能够轻松适应广泛的分割任务。在训练过程中，补丁大小、批处理大小和网络配置 (例如，分辨率状态的数量和沿不同轴的下采样操作的数量) 与 nnU-Net 保持一致 (见表2) 。U-Mamba 还使用了随机梯度下降进行优化，损失函数是 Dice loss 和交叉熵的无权重和。这是因为复合损失在不同任务中已被证明具有鲁棒性。在推断阶段，所有实验都禁用了测试时增强 (TTA) ，以获得更简洁高效的评估过程，因为 TTA 会使 2D 和 3D 数据集的计算负担增加 4 倍和 8 倍。

![image-20240307163840090](https://cdn.jsdelivr.net/gh/ZL85/ImageBed@main//202403071638189.png)

### Benchmarking

我们将 U-Mamba 与两个基于 CNN 的分割网络 (nnUNet 和 SegResNet) 以及两个基于 Transformer 的网络 (UNETR 和 SwinUNETR) 进行了比较，这些网络在医学图像分割竞赛中被广泛使用。为了公平比较，我们还将 SegResNet、UNETR 和 SwinUNETR 实现到 nnU-Net 框架中，并使用它们建议的优化器 (例如 Adam 和 AdamW ) 进行模型训练。我们使用了 nnU-Net 中的默认图像预处理。所有网络都在相同的批处理大小下在一个 NVIDIA A100 GPU 上从头开始训练了 1000 个 epoch (见表2) 。

根据《Metrics Reloaded》的建议，我们使用了 Dice 相似性系数 (DSC) 和标准化表面距离 (NSD) 来评估三个语义分割任务，包括 CT 和 MRI 扫描中的器官分割以及内窥镜图像中的器械分割。对于细胞分割质量的评估，使用了 F1 分数，因为这是一个实例分割任务。

### Quantitative and qualitative segmentation results

3D 腹部 CT 和 MRI 数据集上器官分割的结果总结。U-Mamba_Bot：只在瓶颈处使用 U-Mmaba 块。UMamba_Enc：所有编码器块都是 U-Mmaba 块。

![image-20240307163932775](https://cdn.jsdelivr.net/gh/ZL85/ImageBed@main//202403071639835.png)

表 3 显示了腹部器官在 CT 和 MRI 扫描中的定量 3D 分割结果。U-Mamba 超越了基于 CNN 和 Transformer 的分割网络，分别在腹部 CT 和 MR 数据集上实现了平均 DSC 分数为 0.8683 (U-Mamba_Bot) 和 0.8501 (U-Mamba_Enc)。nnU-Net 表现竞争力强，明显优于 SegResNet、UNETR 和 SwinUNETR，但仍然显示出 U-Mamba 的优势，如图 2 所示。基于六个网络的可视化分割结果，U-Mamba 在分割结果中具有较少的异常值。例如，U-Mama 能够生成更准确的肝脏和胃的分割掩码，而其他方法在腹部 CT 扫描中对于肝脏掩码存在过分割错误，对于胃掩码存在缺失区域。同样，在 MRI 扫描中，对于胆囊的分割，U-Mamba 成功地描绘了其边界，而其他方法产生了各种分割错误。这些观察也体现在对应器官的 DSC 和 NSD 分数中 (附录表 5 和表 6) 。

图 2. CT 扫描（第 1 行和第 2 行）和 MRI 扫描（第 3 行和第 4 行）中腹部器官分割的可视化示例。U-Mamba 具有更好的能力区分腹部复杂的软组织。

![image-20240307164013939](https://cdn.jsdelivr.net/gh/ZL85/ImageBed@main//202403071640107.png)

表 4. 2D 分割任务的结果总结：腹部MRI扫描中的器官分割、内窥镜图像中的器械分割以及显微镜图像中的细胞分割。

![image-20240307164048828](https://cdn.jsdelivr.net/gh/ZL85/ImageBed@main//202403071640883.png)

表 4 呈现了定量的 2D 分割结果。与 CT 扫描相比，MRI 扫描通常具有更多的异构间隔，而 2D 分割网络在实践中也是一个常见的选择。因此，我们还在腹部器官分割的 2D 设置下比较了所有网络，其中每个 3D MRI 扫描都被转换为多个 2D 切片。U-Mamba 再次在三个 2D 分割任务中展现了其在现有方法上的优势，分别实现了器官、器械和细胞分割的最佳平均 DSC 分别为 0.7625、0.6504 和 F1 分数为 0.5607。图2中的定性结果显示，nnU-Net、UNETR 和 SwinUNETR 在脾脏的分割中因外观异质性而产生混淆。UNETR 和 SwinUNETR 在显微镜图像中还生成了许多细胞异常，而 nnU-Net 未能成功识别内窥镜图像中的大型针头驱动器。相反，U-Mamba 在这些场景中显示出明显的优势，表明其更好地捕捉全局上下文的能力。

![image-20240307164111680](https://cdn.jsdelivr.net/gh/ZL85/ImageBed@main//202403071641856.png)

## Discussion and conclusion

在本文中，我们介绍了 U-Mamba，以解决由于 CNN 的固有局部性和 Transformer 的计算复杂性而导致的建模长程依赖性的挑战。全面的实验结果显示，U-Mamaba 在各种模态和分割目标上均优于现有的基于 CNN 和 Transformer 的分割网络。特别是，U-Mamba 在处理外观异质性的对象方面表现出卓越的能力，导致更少的分割异常。性能的提升主要归因于 U-Mamba 的架构设计，可以同时提取多尺度的局部特征并捕捉长程依赖性。

Transformers 在许多自然图像分割任务中表现出更强大的性能。然而，在医学图像分割中，它们并未取得转变性的成果。这一点显而易见，因为在医学图像分割竞赛中获胜的解决方案仍然主要依赖于 CNN，比如 nnU-Net 和 SegResNet。有趣的是，我们还观察到，在所有我们测试的情景中，基于 Transformer 的网络相对于基于 CNN 的网络表现不佳，尽管它们使用了它们的原始网络实现，并使用了推荐的优化器进行训练。这可能是因为需要使用多个 GPU 对这些网络进行训练，而不是一个 GPU。然而，这会导致不公平的比较，因为所有其他网络都是在只有一个 GPU 的情况下进行训练的。另一个原因可能是 Transformers 应该在大规模的预训练和微调范式中使用。为了保持评估的一致性和公平性，我们从头开始训练了所有网络，并在所有实验中使用了相同的预处理和数据增强技术。我们相信社区协作和透明度的价值，因此我们已经公开了我们比较方法的实现，供研究社区进一步检查和使用。

此外，nnU-Net 在大多数任务上都表现出很强的竞争力，但 U-Mamba 取得了整体更好的分数。我们注意到在 CT 和 MRI 扫描中，nnU-Net 和 U-Mamba 对于某些器官，如主动脉、肾脏和下腔静脉，在分割性能上具有互补的特性，如附录表 5-7 所示。这表明有可能通过模型集成进一步提高它们的性能，这是在医学图像分割竞赛中经常采用的一种策略。

虽然这项工作的主要焦点是新的分割架构，但 U-Mamba 还有许多进一步增强和扩展的可能性。一个即时的方向是利用大规模数据集对 U-Mamba 进行训练，旨在创建可直接部署的分割工具或提供用于在数据受限任务上进行微调的预训练模型权重，这类似于 TotalSegmentator 和 STU-Net 等类似倡议的示例。此外，U-Mamba 的设计本质上支持与先进技术的集成，如用于小数据集的强数据增强、用于高度不平衡目标的损失函数，以及嵌套对象的基于区域的训练。此外，U-Mamba 块为在分类和检测网络中应用提供了一个新的机会，以更好地建模长程依赖性。我们将这些方向作为近期的工作。

总之，本文提出了一种新的架构——U-Mamba，用于通用的生物医学图像分割，该架构融合了 CNNs 的局部模式识别和 Mamba 的全局上下文理解的优势。U-Mamba 可以自动配置自身以适应不同的数据集，使其成为生物医学成像中多样分割任务的通用而灵活的工具。结果表明，U-Mamba 是作为下一代生物医学图像分割网络骨干的有希望的候选者。
